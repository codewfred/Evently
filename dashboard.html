<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="dashboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="images/favicon.png">
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <img
            src="images/Evently__1_-removebg-preview.png"
            alt="School Logo"
            class="logo"
          />

        </div>
        <nav class="sidebar-nav">
          <a href="#" class="active" data-nav="events">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
              />
            </svg>
            Events
          </a>
          <a href="#" data-nav="create-events">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Create
          </a>
          <a href="#" data-nav="event-log">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </svg>
            Event log
          </a>
          <a href="#" data-nav="bookmarked">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/>
            </svg>
            Bookmarked
          </a>

          <a href="#" data-nav="log-out">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"
              />
            </svg>
            Log Out
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="dashboard-main">
        <header class="main-header">
          <div class="user-display">
            <img src="images/default-profile.png" alt="Profile Picture" class="user-display-pic">
            <span class="user-display-email" id="userEmail"></span>
          </div>
        </header>
        <div id="scrollable-content">
          <div id="create-event-form-container" style="display: none;">
            <h2>Create Event</h2>
            <form id="create-event-form">
              <div class="form-group">
                <label for="event-name">Event Name</label>
                <input type="text" id="event-name" name="event-name" required>
              </div>
              <div class="form-group">
                <label for="event-date">Event Date</label>
                <input type="date" id="event-date" name="event-date" required>
              </div>
              <div class="form-group">
                <label for="event-time">Event Time</label>
                <input type="time" id="event-time" name="event-time" required>
              </div>
              <div class="form-group">
                <label for="event-location">Event Location</label>
                <input type="text" id="event-location" name="event-location" required>
              </div>
              <div class="form-group">
                <label for="event-description">Event Description</label>
                <textarea id="event-description" name="event-description" rows="4" required></textarea>
              </div>
              <button type="submit">Create Event</button>
            </form>
          </div>
          <div id="events-header" style="display: none;">
            <h2>Your Events</h2>
          </div>
          <div id="events-container">
            <!-- Events will be displayed here -->
          </div>
        </div>
      </main>

    </div>
    <div class="bottom-nav">
        <a href="#" class="active" data-nav="events">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
              />
            </svg>
          </a>
          <a href="#" data-nav="create-events">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
          </a>
          <a href="#" data-nav="event-log">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </svg>
          </a>
          <a href="#" data-nav="bookmarked">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/>
            </svg>
          </a>

          <a href="#" data-nav="log-out">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"
              />
            </svg>
          </a>
    </div>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      deleteDoc,
      doc,
      updateDoc,
      getDoc,
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";


    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDMm70P5KI7NoChVWslANd9ClSm6F_CEdw",
      authDomain: "evently-acf4a.firebaseapp.com",
      projectId: "evently-acf4a",
      storageBucket: "evently-acf4a.firebasestorage.app",
      messagingSenderId: "1082264704588",
      appId: "1:1082264704588:web:286adf3d27e4fb2cd586e9",
      measurementId: "G-K4GNWM75NJ",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const sidebarLinks = document.querySelectorAll(".sidebar-nav a");
    const createEventFormContainer = document.getElementById('create-event-form-container');
    const eventsContainer = document.getElementById('events-container');
    const eventsHeader = document.getElementById('events-header');
    const createEventForm = document.getElementById('create-event-form');
    const bottomNavLinks = document.querySelectorAll('.bottom-nav a');
    let currentEditEventId = null;

    bottomNavLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            bottomNavLinks.forEach((l) => l.classList.remove("active"));
            link.classList.add("active");

            const navTo = link.getAttribute('data-nav');
            currentEditEventId = null; // Reset edit state on navigation
            document.querySelector('#create-event-form-container h2').textContent = 'Create Event';
            document.querySelector('#create-event-form button').textContent = 'Create Event';

            if (navTo === "events") {
                createEventFormContainer.style.display = 'none';
                eventsContainer.style.display = 'grid';
                eventsHeader.style.display = 'block';
                eventsHeader.querySelector('h2').textContent = 'All Events';
                displayEvents();
            } else if (navTo === "create-events") {
                createEventForm.reset();
                createEventFormContainer.style.display = 'block';
                eventsContainer.style.display = 'none';
                eventsHeader.style.display = 'none';
            } else if (navTo === "event-log") {
                createEventFormContainer.style.display = 'none';
                eventsContainer.style.display = 'grid';
                eventsHeader.style.display = 'block';
                eventsHeader.querySelector('h2').textContent = 'My Events';
                displayUserEvents();
            } else if (navTo === "bookmarked") {
                createEventFormContainer.style.display = 'none';
                eventsContainer.style.display = 'grid';
                eventsHeader.style.display = 'block';
                eventsHeader.querySelector('h2').textContent = 'Bookmarked';
                displayBookmarkedEvents();
            } else if (navTo === "log-out") {
                signOut(auth).then(() => {
                    window.location.href = "login.html";
                });
            }
        });
    });

    // Function to format date
    function formatEventDate(dateString) {
        const date = new Date(dateString);
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        // We add timeZone: 'UTC' to avoid issues with the date changing based on the user's timezone
        return date.toLocaleDateString('en-US', { ...options, timeZone: 'UTC' });
    }

    // Function to format time
    function formatEventTime(timeString) {
        const [hour, minute] = timeString.split(':');
        const hourNum = parseInt(hour, 10);
        const ampm = hourNum >= 12 ? 'PM' : 'AM';
        let hour12 = hourNum % 12;
        if (hour12 === 0) {
            hour12 = 12; // the hour '0' should be '12'
        }
        return `${hour12}:${minute} ${ampm}`;
    }

    // Function to display all events
    async function displayEvents() {
      eventsContainer.innerHTML = ''; // Clear previous events
      const user = auth.currentUser;
      if (!user) return;

      const bookmarksCollection = collection(db, "bookmarks");
      const q = query(bookmarksCollection, where("userId", "==", user.uid));
      const bookmarksSnapshot = await getDocs(q);
      const bookmarkedEventIds = bookmarksSnapshot.docs.map(doc => doc.data().eventId);

      const eventsCollection = collection(db, "events");
      const eventsSnapshot = await getDocs(eventsCollection);
      const eventsList = eventsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
      const colors = ['#ff6347', '#4682b4', '#3cb371', '#ffd700', '#ba55d3', '#ff8c00'];

      if (eventsList.length === 0) {
        eventsContainer.innerHTML = '<p>No events found.</p>';
        return;
      }

      eventsList.forEach((event, index) => {
        event.bookmarked = bookmarkedEventIds.includes(event.id);
        const eventElement = document.createElement('div');
        eventElement.classList.add('event-card');
        const color = colors[index % colors.length];
        eventElement.style.borderBottom = `5px solid ${color}`;
        eventElement.innerHTML = `
          <i class="${event.bookmarked ? 'fa-solid' : 'fa-regular'} fa-bookmark bookmark-icon ${event.bookmarked ? 'bookmarked' : ''}" data-id="${event.id}" data-bookmarked="${event.bookmarked}"></i>
          <h3>${event.name}</h3>
          <p><strong>Date:</strong> ${formatEventDate(event.date)}</p>
          <p><strong>Time:</strong> ${formatEventTime(event.time)}</p>
          <p><strong>Location:</strong> ${event.location}</p>
          <p><strong>Description:</strong> ${event.description}</p>
        `;
        eventsContainer.appendChild(eventElement);
      });
    }

    // Function to display user-specific events in the event log
    async function displayUserEvents() {
        eventsContainer.innerHTML = ''; // Clear previous events
        const user = auth.currentUser;
        if (!user) return;

        const bookmarksCollection = collection(db, "bookmarks");
        const bq = query(bookmarksCollection, where("userId", "==", user.uid));
        const bookmarksSnapshot = await getDocs(bq);
        const bookmarkedEventIds = bookmarksSnapshot.docs.map(doc => doc.data().eventId);

        const eventsCollection = collection(db, "events");
        const q = query(eventsCollection, where("owner", "==", user.uid));
        const querySnapshot = await getDocs(q);
        const eventsList = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const colors = ['#ff6347', '#4682b4', '3cb371', '#ffd700', '#ba55d3', '#ff8c00'];

        if (eventsList.length === 0) {
            eventsContainer.innerHTML = '<p>You have not created any events yet.</p>';
            return;
        }

        eventsList.forEach((event, index) => {
            event.bookmarked = bookmarkedEventIds.includes(event.id);
            const eventElement = document.createElement('div');
            eventElement.classList.add('event-card');
            const color = colors[index % colors.length];
            eventElement.style.borderBottom = `5px solid ${color}`;
            eventElement.innerHTML = `
                <i class="${event.bookmarked ? 'fa-solid' : 'fa-regular'} fa-bookmark bookmark-icon ${event.bookmarked ? 'bookmarked' : ''}" data-id="${event.id}" data-bookmarked="${event.bookmarked}"></i>
                <h3>${event.name}</h3>
                <p><strong>Date:</strong> ${formatEventDate(event.date)}</p>
                <p><strong>Time:</strong> ${formatEventTime(event.time)}</p>
                <p><strong>Location:</strong> ${event.location}</p>
                <p><strong>Description:</strong> ${event.description}</p>
                <div class="event-actions">
                    <button class="edit-btn" data-id="${event.id}">Edit</button>
                    <button class="delete-btn" data-id="${event.id}">Delete</button>
                </div>
            `;
            eventsContainer.appendChild(eventElement);
        });
    }

    // Handle Edit Event
    async function handleEditEvent(eventId) {
        currentEditEventId = eventId;
        const eventDoc = await getDoc(doc(db, "events", eventId));
        if (eventDoc.exists()) {
            const eventData = eventDoc.data();
            document.getElementById('event-name').value = eventData.name;
            document.getElementById('event-date').value = eventData.date;
            document.getElementById('event-time').value = eventData.time;
            document.getElementById('event-location').value = eventData.location;
            document.getElementById('event-description').value = eventData.description;

            // Show the form for editing
            createEventFormContainer.style.display = 'block';
            eventsContainer.style.display = 'none';
            eventsHeader.style.display = 'none';
            document.querySelector('#create-event-form-container h2').textContent = 'Edit Event';
            document.querySelector('#create-event-form button').textContent = 'Update Event';
        }
    }

    // Handle Delete Event
    async function handleDeleteEvent(eventId) {
        if (confirm('Are you sure you want to delete this event?')) {
            try {
                await deleteDoc(doc(db, "events", eventId));
                alert('Event deleted successfully!');
                displayUserEvents(); // Refresh the event log
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }
    }

    // Toggle Bookmark
    async function toggleBookmark(eventId) {
        const user = auth.currentUser;
        if (!user) return;

        const bookmarksCollection = collection(db, "bookmarks");
        const q = query(bookmarksCollection, where("userId", "==", user.uid), where("eventId", "==", eventId));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            // Add bookmark
            try {
                await addDoc(bookmarksCollection, {
                    userId: user.uid,
                    eventId: eventId,
                });
            } catch (error) {
                console.error("Error adding bookmark: ", error);
            }
        } else {
            // Remove bookmark
            querySnapshot.forEach(async (doc) => {
                try {
                    await deleteDoc(doc.ref);
                }
                catch (error) {
                    console.error("Error removing bookmark: ", error);
                }
            });
        }

        // Refresh the view
        const activeLink = document.querySelector('.sidebar-nav a.active');
        if (activeLink) {
            activeLink.click();
        }
    }

    // Function to display bookmarked events
    async function displayBookmarkedEvents() {
        eventsContainer.innerHTML = ''; // Clear previous events
        const user = auth.currentUser;
        if (!user) return;

        const bookmarksCollection = collection(db, "bookmarks");
        const q = query(bookmarksCollection, where("userId", "==", user.uid));
        const bookmarksSnapshot = await getDocs(q);
        const bookmarkedEventIds = bookmarksSnapshot.docs.map(doc => doc.data().eventId);

        const colors = ['#ff6347', '#4682b4', '#3cb371', '#ffd700', '#ba55d3', '#ff8c00'];

        if (bookmarkedEventIds.length === 0) {
            eventsContainer.innerHTML = '<p>You have not bookmarked any events yet.</p>';
            return;
        }

        const eventsPromises = bookmarkedEventIds.map(eventId => getDoc(doc(db, "events", eventId)));
        const eventDocs = await Promise.all(eventsPromises);

        eventDocs.forEach((eventDoc, index) => {
            if (eventDoc.exists()) {
                const event = {id: eventDoc.id, ...eventDoc.data()};
                event.bookmarked = true; // Since we are in displayBookmarkedEvents, all events are bookmarked
                const eventElement = document.createElement('div');
                eventElement.classList.add('event-card');
                const color = colors[index % colors.length];
                eventElement.style.borderBottom = `5px solid ${color}`;
                eventElement.innerHTML = `
                    <i class="fa-solid fa-bookmark bookmark-icon bookmarked" data-id="${event.id}"></i>
                    <h3>${event.name}</h3>
                    <p><strong>Date:</strong> ${formatEventDate(event.date)}</p>
                    <p><strong>Time:</strong> ${formatEventTime(event.time)}</p>
                    <p><strong>Location:</strong> ${event.location}</p>
                    <p><strong>Description:</strong> ${event.description}</p>
                `;
                eventsContainer.appendChild(eventElement);
            }
        });
    }

    eventsContainer.addEventListener('click', (e) => {
        const target = e.target;
        const eventId = target.getAttribute('data-id');

        if (target.classList.contains('bookmark-icon')) {
            toggleBookmark(eventId);
        } else if (target.classList.contains('edit-btn')) {
            handleEditEvent(eventId);
        } else if (target.classList.contains('delete-btn')) {
            handleDeleteEvent(eventId);
        }
    });


    sidebarLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        sidebarLinks.forEach((l) => l.classList.remove("active"));
        link.classList.add("active");

        const navTo = link.getAttribute('data-nav');
        currentEditEventId = null; // Reset edit state on navigation
        document.querySelector('#create-event-form-container h2').textContent = 'Create Event';
        document.querySelector('#create-event-form button').textContent = 'Create Event';


        if (navTo === "events") {
          createEventFormContainer.style.display = 'none';
          eventsContainer.style.display = 'grid';
          eventsHeader.style.display = 'block';
          eventsHeader.querySelector('h2').textContent = 'All Events';
          displayEvents();
        } else if (navTo === "create-events") {
          createEventForm.reset();
          createEventFormContainer.style.display = 'block';
          eventsContainer.style.display = 'none';
          eventsHeader.style.display = 'none';
        } else if (navTo === "event-log") {
          createEventFormContainer.style.display = 'none';
          eventsContainer.style.display = 'grid';
          eventsHeader.style.display = 'block';
          eventsHeader.querySelector('h2').textContent = 'My Events';
          displayUserEvents();
        } else if (navTo === "bookmarked") {
          createEventFormContainer.style.display = 'none';
          eventsContainer.style.display = 'grid';
          eventsHeader.style.display = 'block';
          eventsHeader.querySelector('h2').textContent = 'Bookmarked';
          displayBookmarkedEvents();
        } else if (navTo === "log-out") {
          signOut(auth).then(() => {
            window.location.href = "login.html";
          });
        }
      });
    });

    // Handle form submission for both create and update
    createEventForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const eventName = document.getElementById('event-name').value;
        const eventDate = document.getElementById('event-date').value;
        const eventTime = document.getElementById('event-time').value;
        const eventLocation = document.getElementById('event-location').value;
        const eventDescription = document.getElementById('event-description').value;

        if (eventName && eventDate && eventTime && eventLocation && eventDescription) {
            const eventData = {
                name: eventName,
                date: eventDate,
                time: eventTime,
                location: eventLocation,
                description: eventDescription,
                owner: auth.currentUser.uid
            };

            try {
                if (currentEditEventId) {
                    // Update existing event
                    const eventRef = doc(db, "events", currentEditEventId);
                    await updateDoc(eventRef, eventData);
                    alert('Event updated successfully!');
                } else {
                    // Create new event
                    const docRef = await addDoc(collection(db, "events"), eventData);
                    console.log("Document written with ID: ", docRef.id);
                    alert('Event created successfully!');
                }
                createEventForm.reset();
                currentEditEventId = null;
                // Switch to event log view
                sidebarLinks.forEach(link => {
                    if (link.textContent.trim() === 'Event log') {
                        link.click();
                    }
                });
            } catch (error) {
                console.error("Error saving document: ", error);
                alert('Error saving event. Please try again.');
            }
        } else {
            alert('Please fill out all fields.');
        }
    });


    // Firebase Authentication State
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const email = user.email;
        document.getElementById("userEmail").textContent = email;
        // Initially display all events
        eventsHeader.style.display = 'block';
        eventsContainer.style.display = 'grid';
        eventsHeader.querySelector('h2').textContent = 'All Events';
        displayEvents();
      } else {
        // User is signed out
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
